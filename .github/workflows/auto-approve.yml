name: Auto-Approve after Copilot Review

on:
  # Manual trigger - use this after Copilot finishes reviewing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to approve'
        required: true
        type: number

jobs:
  auto-approve:
    name: Auto-Approve PR
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Check review status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.inputs.pr_number }}
          REPO=${{ github.repository }}

          echo "Checking review status for PR #$PR_NUMBER..."

          # Count Copilot reviews
          REVIEW_COUNT=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" \
            --jq '[.[] | select(.user.login | contains("copilot"))] | length')

          echo "Copilot reviews: $REVIEW_COUNT"

          # Count unresolved threads (any author)
          UNRESOLVED=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes { isResolved }
                  }
                }
              }
            }' -f owner="${REPO%/*}" -f repo="${REPO#*/}" -F pr="$PR_NUMBER" \
            --jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length' 2>/dev/null || echo "0")

          echo "Unresolved threads: $UNRESOLVED"

          if [ "$REVIEW_COUNT" -ge 2 ] && [ "$UNRESOLVED" -eq 0 ]; then
            echo "should_approve=true" >> $GITHUB_OUTPUT
            echo "✅ $REVIEW_COUNT reviews, 0 unresolved - ready to approve"
          else
            echo "should_approve=false" >> $GITHUB_OUTPUT
            echo "⏳ Need: ≥2 reviews (have $REVIEW_COUNT), 0 unresolved (have $UNRESOLVED)"
          fi

      - name: Auto-approve PR
        if: steps.check.outputs.should_approve == 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTO_APPROVE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.inputs.pr_number }}

          gh pr review "$PR_NUMBER" --approve --body "✅ Auto-approved: ≥2 Copilot reviews completed with no unresolved comments.

          _This approval was automatically granted by the CI workflow._"

          echo "✅ PR #$PR_NUMBER approved!"
