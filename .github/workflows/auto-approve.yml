name: Auto-Approve after Copilot Review

on:
  # Automatic trigger when a PR review is submitted
  pull_request_review:
    types: [submitted]

  # Manual trigger as fallback
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to approve'
        required: true
        type: number

jobs:
  auto-approve:
    name: Auto-Approve PR
    runs-on: ubuntu-latest
    # Only run for Copilot reviews or manual trigger
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.user.login, 'copilot'))

    permissions:
      pull-requests: write
      contents: read
      checks: read
      actions: read

    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Initial delay
        run: |
          echo "Waiting 30 seconds for CI to start..."
          sleep 30

      - name: Wait for CI to complete
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          REPO=${{ github.repository }}

          echo "Waiting for CI checks to complete on PR #$PR_NUMBER..."

          # Get the HEAD SHA of the PR
          HEAD_SHA=$(gh api "repos/$REPO/pulls/$PR_NUMBER" --jq '.head.sha')
          echo "HEAD SHA: $HEAD_SHA"

          # Wait up to 30 minutes for checks to complete
          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            # Get check runs status
            CHECK_STATUS=$(gh api "repos/$REPO/commits/$HEAD_SHA/check-runs" \
              --jq '{
                total: .total_count,
                completed: [.check_runs[] | select(.status == "completed")] | length,
                success: [.check_runs[] | select(.conclusion == "success")] | length,
                failure: [.check_runs[] | select(.conclusion == "failure")] | length,
                pending: [.check_runs[] | select(.status != "completed")] | length
              }')

            TOTAL=$(echo "$CHECK_STATUS" | jq -r '.total')
            COMPLETED=$(echo "$CHECK_STATUS" | jq -r '.completed')
            SUCCESS=$(echo "$CHECK_STATUS" | jq -r '.success')
            FAILURE=$(echo "$CHECK_STATUS" | jq -r '.failure')
            PENDING=$(echo "$CHECK_STATUS" | jq -r '.pending')

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: $COMPLETED/$TOTAL checks completed ($SUCCESS success, $FAILURE failure, $PENDING pending)"

            # If any check failed, exit early
            if [ "$FAILURE" -gt 0 ]; then
              echo "‚ùå CI failed! $FAILURE check(s) failed."
              exit 1
            fi

            # If all checks completed successfully
            if [ "$COMPLETED" -eq "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
              echo "‚úÖ All $TOTAL CI checks passed!"
              break
            fi

            # Wait 30 seconds before next check
            sleep 30
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚è∞ Timeout waiting for CI checks"
            exit 1
          fi

      - name: Check approval conditions
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          REPO=${{ github.repository }}
          OWNER="${REPO%/*}"
          REPO_NAME="${REPO#*/}"

          echo "Checking approval conditions for PR #$PR_NUMBER..."

          # 1. Check time since last push (must be at least 2 minutes)
          LAST_PUSH=$(gh api "repos/$REPO/pulls/$PR_NUMBER" --jq '.head.repo.pushed_at')
          LAST_PUSH_TS=$(date -d "$LAST_PUSH" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$LAST_PUSH" +%s 2>/dev/null || echo "0")
          NOW_TS=$(date +%s)
          MINUTES_SINCE_PUSH=$(( (NOW_TS - LAST_PUSH_TS) / 60 ))
          echo "Minutes since last push: $MINUTES_SINCE_PUSH"

          if [ "$MINUTES_SINCE_PUSH" -lt 2 ]; then
            echo "should_approve=false" >> $GITHUB_OUTPUT
            echo "reason=Only $MINUTES_SINCE_PUSH minutes since last push (need 2+)" >> $GITHUB_OUTPUT
            echo "‚è≥ Too soon after push: $MINUTES_SINCE_PUSH minutes (need 2+)"
            exit 0
          fi

          # 2. Count Copilot reviews
          REVIEW_COUNT=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" \
            --jq '[.[] | select(.user.type == "Bot" and (.user.login | contains("copilot")))] | length')
          echo "Copilot reviews: $REVIEW_COUNT"

          if [ "$REVIEW_COUNT" -eq 0 ]; then
            echo "should_approve=false" >> $GITHUB_OUTPUT
            echo "reason=No Copilot review found" >> $GITHUB_OUTPUT
            echo "‚è≥ No Copilot review yet"
            exit 0
          fi

          # 3. Check unresolved review threads
          UNRESOLVED=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes { isResolved }
                  }
                }
              }
            }' -f owner="$OWNER" -f repo="$REPO_NAME" -F pr="$PR_NUMBER" \
            --jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length' 2>/dev/null || echo "0")

          echo "Unresolved threads: $UNRESOLVED"

          if [ "$UNRESOLVED" -gt 0 ]; then
            echo "should_approve=false" >> $GITHUB_OUTPUT
            echo "should_dismiss=true" >> $GITHUB_OUTPUT
            echo "reason=$UNRESOLVED unresolved review thread(s)" >> $GITHUB_OUTPUT
            echo "‚è≥ Cannot approve: $UNRESOLVED unresolved thread(s)"
            exit 0
          fi

          # 4. All conditions met - approve
          echo "should_approve=true" >> $GITHUB_OUTPUT
          echo "reason=Copilot reviewed ($REVIEW_COUNT reviews), 0 unresolved threads, ${MINUTES_SINCE_PUSH}min since push" >> $GITHUB_OUTPUT
          echo "‚úÖ All conditions met - ready to approve"

      - name: Dismiss stale approval if conditions not met
        if: steps.check.outputs.should_dismiss == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          REPO=${{ github.repository }}
          REASON="${{ steps.check.outputs.reason }}"

          echo "Checking for stale approvals to dismiss..."

          # Find auto-approve reviews (from github-actions bot)
          REVIEW_IDS=$(gh api "repos/$REPO/pulls/$PR_NUMBER/reviews" \
            --jq '[.[] | select(.state == "APPROVED" and (.user.login | contains("github-actions") or contains("bot")))] | .[].id')

          if [ -n "$REVIEW_IDS" ]; then
            for REVIEW_ID in $REVIEW_IDS; do
              echo "Dismissing review $REVIEW_ID..."
              gh api -X PUT "repos/$REPO/pulls/$PR_NUMBER/reviews/$REVIEW_ID/dismissals" \
                -f message="üîÑ Approval dismissed: $REASON. Please resolve issues and re-trigger." \
                2>/dev/null || echo "Could not dismiss review $REVIEW_ID"
            done
            echo "‚ö†Ô∏è Dismissed stale approval(s)"
          else
            echo "No stale approvals to dismiss"
          fi

      - name: Auto-approve PR
        if: steps.check.outputs.should_approve == 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTO_APPROVE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          REASON="${{ steps.check.outputs.reason }}"

          REPO=${{ github.repository }}
          gh pr review "$PR_NUMBER" --repo "$REPO" --approve --body "‚úÖ Auto-approved: $REASON

          _This approval was automatically granted by the claude-threads CI workflow._"

          echo "‚úÖ PR #$PR_NUMBER approved!"

      - name: Skip approval (conditions not met)
        if: steps.check.outputs.should_approve == 'false'
        run: |
          echo "‚è≥ Skipping approval: ${{ steps.check.outputs.reason }}"
          echo "Please ensure:"
          echo "  - All review threads are resolved"
          echo "  - All review comments are answered"
          echo "  - At least 2 minutes since last push"
          echo "  - Copilot has completed review"
