#!/bin/bash
#
# pre-commit hook - Code quality checks and auto version bump
#
# This hook runs:
#   1. Rust formatting check (cargo fmt)
#   2. Rust linting (cargo clippy) - optional
#   3. Kotlin formatting check (spotless)
#   4. TypeScript/JavaScript lint (Biome)
#   5. TypeScript type checking
#   6. Auto-bump patch version
#
# To install this hook:
#   ./scripts/install-hooks.sh
#
# For AI agents: If this hook fails, the error message will explain
# exactly what command to run to fix the issue.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If running from .git/hooks, adjust path to scripts
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
    SCRIPTS_DIR="$ROOT_DIR/scripts"
else
    ROOT_DIR="$(dirname "$SCRIPT_DIR")"
    SCRIPTS_DIR="$SCRIPT_DIR"
fi

VERSION_FILE="$ROOT_DIR/VERSION"
BUMP_SCRIPT="$SCRIPTS_DIR/bump-version.sh"
BACKEND_DIR="$ROOT_DIR/backend"
MOBILE_NATIVE_DIR="$ROOT_DIR/mobile-native"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Track if any check failed
FAILED=0

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

# =============================================================================
# Check 1: Rust Formatting (cargo fmt)
# =============================================================================
if echo "$STAGED_FILES" | grep -q '^backend/.*\.rs$'; then
    echo -e "${CYAN}Checking Rust formatting...${NC}"

    if ! (cd "$BACKEND_DIR" && cargo fmt --all -- --check 2>/dev/null); then
        echo ""
        echo -e "${RED}╔══════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${RED}║  PRE-COMMIT HOOK FAILED: Rust formatting check failed            ║${NC}"
        echo -e "${RED}╠══════════════════════════════════════════════════════════════════╣${NC}"
        echo -e "${RED}║  Some Rust files are not properly formatted.                     ║${NC}"
        echo -e "${RED}║                                                                  ║${NC}"
        echo -e "${RED}║  TO FIX: Run the following command:                              ║${NC}"
        echo -e "${RED}║                                                                  ║${NC}"
        echo -e "${YELLOW}║    cd backend && cargo fmt --all                                 ║${NC}"
        echo -e "${RED}║                                                                  ║${NC}"
        echo -e "${RED}║  Then stage the changes and commit again:                        ║${NC}"
        echo -e "${RED}║                                                                  ║${NC}"
        echo -e "${YELLOW}║    git add -u && git commit                                      ║${NC}"
        echo -e "${RED}╚══════════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        FAILED=1
    else
        echo -e "${GREEN}✓ Rust formatting OK${NC}"
    fi
fi

# =============================================================================
# Check 2: Rust Clippy (optional - can be slow)
# =============================================================================
# Uncomment to enable clippy in pre-commit (may slow down commits)
# if echo "$STAGED_FILES" | grep -q '^backend/.*\.rs$'; then
#     echo -e "${CYAN}Running Rust linter (clippy)...${NC}"
#
#     if ! (cd "$BACKEND_DIR" && cargo clippy --workspace -- -D warnings 2>/dev/null); then
#         echo ""
#         echo -e "${RED}╔══════════════════════════════════════════════════════════════════╗${NC}"
#         echo -e "${RED}║  PRE-COMMIT HOOK FAILED: Rust clippy check failed                ║${NC}"
#         echo -e "${RED}╠══════════════════════════════════════════════════════════════════╣${NC}"
#         echo -e "${RED}║  Clippy found warnings or errors in Rust code.                   ║${NC}"
#         echo -e "${RED}║                                                                  ║${NC}"
#         echo -e "${RED}║  TO FIX: Run clippy and address the warnings:                    ║${NC}"
#         echo -e "${RED}║                                                                  ║${NC}"
#         echo -e "${YELLOW}║    cd backend && cargo clippy --workspace -- -D warnings         ║${NC}"
#         echo -e "${RED}║                                                                  ║${NC}"
#         echo -e "${RED}║  Then stage the changes and commit again.                        ║${NC}"
#         echo -e "${RED}╚══════════════════════════════════════════════════════════════════╝${NC}"
#         echo ""
#         FAILED=1
#     else
#         echo -e "${GREEN}✓ Rust clippy OK${NC}"
#     fi
# fi

# =============================================================================
# Check 3: Kotlin Formatting (Spotless)
# =============================================================================
if echo "$STAGED_FILES" | grep -q '^mobile-native/.*\.kt$'; then
    echo -e "${CYAN}Checking Kotlin formatting (Spotless)...${NC}"

    if [[ -f "$MOBILE_NATIVE_DIR/gradlew" ]]; then
        if ! (cd "$MOBILE_NATIVE_DIR" && ./gradlew spotlessCheck --quiet 2>/dev/null); then
            echo ""
            echo -e "${RED}╔══════════════════════════════════════════════════════════════════╗${NC}"
            echo -e "${RED}║  PRE-COMMIT HOOK FAILED: Kotlin formatting check failed          ║${NC}"
            echo -e "${RED}╠══════════════════════════════════════════════════════════════════╣${NC}"
            echo -e "${RED}║  Some Kotlin files are not properly formatted.                   ║${NC}"
            echo -e "${RED}║                                                                  ║${NC}"
            echo -e "${RED}║  TO FIX: Run the following command:                              ║${NC}"
            echo -e "${RED}║                                                                  ║${NC}"
            echo -e "${YELLOW}║    cd mobile-native && ./gradlew spotlessApply                  ║${NC}"
            echo -e "${RED}║                                                                  ║${NC}"
            echo -e "${RED}║  Then stage the changes and commit again:                        ║${NC}"
            echo -e "${RED}║                                                                  ║${NC}"
            echo -e "${YELLOW}║    git add -u && git commit                                      ║${NC}"
            echo -e "${RED}╚══════════════════════════════════════════════════════════════════╝${NC}"
            echo ""
            FAILED=1
        else
            echo -e "${GREEN}✓ Kotlin formatting OK${NC}"
        fi
    fi
fi

# =============================================================================
# Check 4: TypeScript/JavaScript (Biome Lint) - Frontend
# =============================================================================
if echo "$STAGED_FILES" | grep -q '^frontend/.*\.\(ts\|tsx\|js\|jsx\)$'; then
    echo -e "${CYAN}Checking TypeScript/JavaScript formatting...${NC}"

    FRONTEND_DIR="$ROOT_DIR/frontend"
    if [[ -f "$FRONTEND_DIR/package.json" ]]; then
        # Check if pnpm lint exists
        if (cd "$FRONTEND_DIR" && grep -q '"lint"' package.json 2>/dev/null); then
            if ! (cd "$FRONTEND_DIR" && pnpm lint 2>/dev/null); then
                echo ""
                echo -e "${RED}╔══════════════════════════════════════════════════════════════════╗${NC}"
                echo -e "${RED}║  PRE-COMMIT HOOK FAILED: TypeScript/JavaScript lint failed       ║${NC}"
                echo -e "${RED}╠══════════════════════════════════════════════════════════════════╣${NC}"
                echo -e "${RED}║  Biome found issues in frontend code.                            ║${NC}"
                echo -e "${RED}║                                                                  ║${NC}"
                echo -e "${RED}║  TO FIX: Run the following command:                              ║${NC}"
                echo -e "${RED}║                                                                  ║${NC}"
                echo -e "${YELLOW}║    cd frontend && pnpm check:fix                                 ║${NC}"
                echo -e "${RED}║                                                                  ║${NC}"
                echo -e "${RED}║  Then stage the changes and commit again:                        ║${NC}"
                echo -e "${RED}║                                                                  ║${NC}"
                echo -e "${YELLOW}║    git add -u && git commit                                      ║${NC}"
                echo -e "${RED}╚══════════════════════════════════════════════════════════════════╝${NC}"
                echo ""
                FAILED=1
            else
                echo -e "${GREEN}✓ TypeScript/JavaScript lint OK${NC}"
            fi
        fi
    fi
fi

# =============================================================================
# Check 5: TypeScript Type Checking - Frontend
# =============================================================================
if echo "$STAGED_FILES" | grep -q '^frontend/.*\.\(ts\|tsx\)$'; then
    echo -e "${CYAN}Checking TypeScript types...${NC}"

    FRONTEND_DIR="$ROOT_DIR/frontend"
    if [[ -f "$FRONTEND_DIR/package.json" ]]; then
        if (cd "$FRONTEND_DIR" && grep -q '"typecheck"' package.json 2>/dev/null); then
            if ! (cd "$FRONTEND_DIR" && pnpm typecheck 2>/dev/null); then
                echo ""
                echo -e "${RED}╔══════════════════════════════════════════════════════════════════╗${NC}"
                echo -e "${RED}║  PRE-COMMIT HOOK FAILED: TypeScript type check failed            ║${NC}"
                echo -e "${RED}╠══════════════════════════════════════════════════════════════════╣${NC}"
                echo -e "${RED}║  TypeScript found type errors in frontend code.                  ║${NC}"
                echo -e "${RED}║                                                                  ║${NC}"
                echo -e "${RED}║  TO FIX: Run the following command to see errors:                ║${NC}"
                echo -e "${RED}║                                                                  ║${NC}"
                echo -e "${YELLOW}║    cd frontend && pnpm typecheck                                 ║${NC}"
                echo -e "${RED}║                                                                  ║${NC}"
                echo -e "${RED}║  Fix the type errors and commit again.                           ║${NC}"
                echo -e "${RED}╚══════════════════════════════════════════════════════════════════╝${NC}"
                echo ""
                FAILED=1
            else
                echo -e "${GREEN}✓ TypeScript types OK${NC}"
            fi
        fi
    fi
fi

# =============================================================================
# Exit early if any check failed
# =============================================================================
if [[ $FAILED -eq 1 ]]; then
    echo ""
    echo -e "${RED}Commit aborted due to pre-commit hook failures.${NC}"
    echo -e "${YELLOW}Fix the issues above and try again.${NC}"
    exit 1
fi

# =============================================================================
# Check 6: Version Bump (only if other checks passed)
# =============================================================================

# Check if VERSION file exists
if [[ ! -f "$VERSION_FILE" ]]; then
    echo "VERSION file not found, skipping version bump"
    exit 0
fi

# Check if bump script exists
if [[ ! -f "$BUMP_SCRIPT" ]]; then
    echo "bump-version.sh not found, skipping version bump"
    exit 0
fi

# Skip if VERSION file is already staged (manual bump was done)
if echo "$STAGED_FILES" | grep -q '^VERSION$'; then
    echo "VERSION already changed, skipping auto-bump"
    exit 0
fi

# If only VERSION file or package.json files are staged, skip bump
if echo "$STAGED_FILES" | grep -qvE '^(VERSION|.*package\.json|mobile-native/gradle\.properties|docs/api/typespec/main\.tsp|backend/Cargo\.toml)$'; then
    echo -e "${YELLOW}Auto-bumping patch version...${NC}"

    # Bump patch version
    "$BUMP_SCRIPT" patch

    # Stage the updated files
    git add "$VERSION_FILE"
    git add "$ROOT_DIR/backend/Cargo.toml" 2>/dev/null || true
    git add "$ROOT_DIR/frontend/package.json" 2>/dev/null || true
    git add "$ROOT_DIR/frontend/apps/*/package.json" 2>/dev/null || true
    git add "$ROOT_DIR/frontend/packages/*/package.json" 2>/dev/null || true
    git add "$ROOT_DIR/mobile-native/gradle.properties" 2>/dev/null || true
    git add "$ROOT_DIR/docs/api/typespec/main.tsp" 2>/dev/null || true

    NEW_VERSION=$(cat "$VERSION_FILE" | tr -d '[:space:]')
    echo -e "${GREEN}Version bumped to $NEW_VERSION${NC}"
else
    echo "Only version files changed, skipping auto-bump"
fi

exit 0
