#!/bin/bash
#
# pre-commit hook - Auto-bump patch version on every commit
#
# This hook automatically increments the patch version before each commit.
# Minor and major version bumps must be done manually using:
#   ./scripts/bump-version.sh minor
#   ./scripts/bump-version.sh major
#
# To install this hook:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use the install script:
#   ./scripts/install-hooks.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If running from .git/hooks, adjust path to scripts
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
    SCRIPTS_DIR="$ROOT_DIR/scripts"
else
    ROOT_DIR="$(dirname "$SCRIPT_DIR")"
    SCRIPTS_DIR="$SCRIPT_DIR"
fi

VERSION_FILE="$ROOT_DIR/VERSION"
BUMP_SCRIPT="$SCRIPTS_DIR/bump-version.sh"

# Colors
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Check if VERSION file exists
if [[ ! -f "$VERSION_FILE" ]]; then
    echo "VERSION file not found, skipping version bump"
    exit 0
fi

# Check if bump script exists
if [[ ! -f "$BUMP_SCRIPT" ]]; then
    echo "bump-version.sh not found, skipping version bump"
    exit 0
fi

# Check if this is a version bump commit (avoid infinite loop)
# Skip if the only changes are to VERSION and version-synced files
STAGED_FILES=$(git diff --cached --name-only)

# Skip if VERSION file is already staged (manual bump was done)
if echo "$STAGED_FILES" | grep -q '^VERSION$'; then
    echo "VERSION already changed, skipping auto-bump"
    exit 0
fi

# If only VERSION file or package.json files are staged, skip bump
if echo "$STAGED_FILES" | grep -qvE '^(VERSION|.*package\.json|mobile-native/gradle\.properties)$'; then
    echo -e "${YELLOW}Auto-bumping patch version...${NC}"

    # Bump patch version
    "$BUMP_SCRIPT" patch

    # Stage the updated files
    git add "$VERSION_FILE"
    git add "$ROOT_DIR/frontend/package.json" 2>/dev/null || true
    git add "$ROOT_DIR/frontend/apps/*/package.json" 2>/dev/null || true
    git add "$ROOT_DIR/frontend/packages/*/package.json" 2>/dev/null || true
    git add "$ROOT_DIR/mobile-native/gradle.properties" 2>/dev/null || true

    NEW_VERSION=$(cat "$VERSION_FILE" | tr -d '[:space:]')
    echo -e "${GREEN}Version bumped to $NEW_VERSION${NC}"
else
    echo "Only version files changed, skipping auto-bump"
fi

exit 0
